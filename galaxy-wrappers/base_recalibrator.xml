<tool id="baserecalibrator" name="BaseRecalibrator" version="0.1.0+galaxy0" python_template_version="3.5" profile="21.05">
    <description>Generates recalibration table for Base Quality Score Recalibration (BQSR)</description>
    <command detect_errors="exit_code"><![CDATA[
    echo "Debug Information: '$BAM.metadata.bam_index''" >> "$output1" &&
    echo "BAM variable is '$BAM'" >> "$output1" &&
    echo "FASTA variable is '$FASTA'" >> "$output1" &&
    echo "VCF variable is '$VCF'" >> "$output1" &&

    ln -s '$VCF' known_sites.vcf &&
    ln -s '$FASTA' fasta.fa &&
    ln -s '$BAM' bamfile.bam &&

    #import subprocess
    #set $bam_path = str($BAM)
    #set $groups = subprocess.check_output(["samtools", "view", "-h", str($bam_path)], stderr=subprocess.STDOUT, shell=False).decode('utf-8')
    #if "@RG" not in str($groups)
        echo "BAM file must have read groups" &&
        exit 1
    #end if

    gatk BuildBamIndex -I bamfile.bam &&

    samtools faidx fasta.fa --output fasta.fa.fai &&
    gatk CreateSequenceDictionary -R fasta.fa -O fasta.dict &&

    #if $known_sites.num_sites == "Multiple"
        #for $file in $VCF:
            bgzip -c '$file' > '$file'.gz &&
            tabix -p vcf '$file'.gz && 
        #end for
        gatk BaseRecalibrator -I bamfile.bam -R fasta.fa
        #for $file in $VCF:
            --known-sites '$file'.gz 
        #end for
        -O "$output1"
    #else:
        bgzip -c known_sites.vcf > known_sites.vcf.gz &&
        tabix -p vcf known_sites.vcf.gz && 

        sudo gatk BaseRecalibrator -I bamfile.bam -R fasta.fa --known-sites known_sites.vcf.gz -O "$output1"
    #end if

    ##Input Validation
    --read-validation-stringency '$read_validation_stringency'
    #if $low_quality_tail
        --low-quality-tail '$low_quality_tail'
    #end if
    #if not $disable_sequence_dictionary_validation
        --disable-sequence-dictionary-validation
    #end if
    #if $lenient
        --lenient
    #end if

    ##Read Filters
    #if not $disable_tool_default_read_filters
        --disable-tool-default-read-filters
    #end if
    $read_filter
    $disable_read_filter

    ##Genomic Intervals
    #if $intervals
        --intervals '$intervals'
    #end if
    --interval-padding '$interval_padding'
    #if $exclude_intervals_string
        --exclude-intervals '$exclude_intervals_string'
    #end if
    #if str($exclude_intervals_file) != "None"
        --exclude-intervals '$exclude_intervals_file'
    #end if
    --interval-merging-rule '$interval_merging_rule'
    --interval-set-rule '$interval_set_rule'

    ##Penalties & Buffers
    --bqsr-baq-gap-open-penalty '$bqsr_baq_gap_open_penalty'
    --cloud-prefetch-buffer '$cloud_prefetch_buffer'
    #if $cloud_index_prefetch_buffer
    --cloud-index-prefetch-buffer '$cloud_index_prefetch_buffer'
    #end if

    ##Read Qualities
    #if $use_original_qualitites
        --use-original-qualitites
    #end if
    --quantizing-levels '$quantizing_levels'
    --default-base-qualities '$default_base_qualities'
    --deletions-default-quality $deletions_default_quality
    --insertions-default-quality $insertions_default_quality
    --mismatches-default-quality $mismatches_default_quality

    ##Performance
    --indels-context-size '$indels_context_size'
    --mismatches-context-size '$mismatches_context_size'
    --gcs-max-retries '$gcs_max_retries'
    --maximum-cycle-value '$maximum_cycle_value'
    #if not $disable_bam_index_caching
        --disable-bam-index-caching
    #end if
    #if $use_jdk_deflater
        --use-jdk-deflater
    #end if
    #if $use_jdk_inflater
        --use-jdk-inflater
    #end if
    
    #Labeling
    --binary-tag-name '$binary_tag_name'

    ##Macro Files
    #if str($gatk_config_file)
        --gatk-config-file '$gatk_config_file'
    #end if
    #if str($arguments_file)
        --arguments-file '$arguments_file'
    #end if
    #if str($sequence_dictionary)
        --sequence-dictionary '$sequence_dictionary'
    #end if
    #if str($read_index) != "None"
        --read-index '$read_index'
    #end if
    
    ]]></command>
    <inputs>
        <param type="data" name="BAM" format="bam,sam,cram" label="BAM, SAM, or CRAM file containing reads"/>
        <param type="data" name="FASTA" format="fasta" label="Reference file"/>

        <conditional name="known_sites">
            <param name="num_sites" type="select" label="Number of files containing known sites">
                <option value="single" selected="true">Single</option>
                <option value="multiple">multiple</option>
            </param>
            <when value="single">
                <param type="data" name="VCF" format="vcf" label="Known sites"/>
            </when>
            <when value="multiple">
                <param type="data_collection" collection_type="list" name="VCF" format="vcf" label="Known sites"/>
            </when>
        </conditional>
        
        <section name="Input Validation">
            <param type="select" argument="--read-validation-stringency" label="Validation stringency for all coordinate files">
                <option value="SILENT"  selected="True">SILENT</option>
                <option value="STRICT">STRICT</option>
                <option value="LENIENT">LENIENT</option>
            </param>
            <param type="integer" argument="--low-quality-tail" label="Minimum quality for tails of reads to be considered" value="2" />
            <param type="boolean" argument="--disable-sequence-dictionary-validation" label="Validate inputs with sequence dictionaries" checked="True" help="Disable at your own risk!" />
            <param type="boolean" argument="--lenient" label="Process VCF files leniently" checked="false" />
        </section>
        <section name="Read Filters" expanded="false" help="Refer to GATK tool index for available filters">
            <param type="boolean" argument="--disable-tool-default-read-filters" label="Use default read filters" checked="True" />
            <param type="text" argument="--read-filter" label="Additional read filters to be applied before analysis" optional="True" help="Enter each read filter as you would in the command line: --read-filter 'NAME' --[option] 'VALUE'" />
            <param type="text" argument="--disable-read-filter" label="Read filters to be disabled before analysis" optional="True" help="Enter each read filter as you would in the command line: --disable-read-filter 'NAME'"/>
        </section>
        <section name="Genomic Intervals">
            <param type="text" argument="--intervals" label="Include genomic intervals" optional="True" help="samtools-style genomic intervals to be included (e.g. chr24 or chr24:100-200)" />
            <param type="integer" argument="--interval-padding" label="Amount of padding for each interval (bp)" value="0" help="For example, '-L 1:100' with a padding value of 20 would turn into '-L 1:80-120'."/>
            <param type="text" name="exclude_intervals_string" argument="--exclude-intervals" label="Excluded intervals manually" optional="True" help="samtools-style genomic intervals to be excluded (e.g. chr24 or chr24:100-200)" />
            <param type="data" name="exclude_intervals_file" argument="--exclude-intervals" label="Excluded intervals with file" optional="True" help="File containing genomic intervals to be excluded (e.g. chr24 or chr24:100-200)" />
            <param type="integer" argument="--interval-exclusion-padding" label="Padding to add to each excluded interval (bp)" value="0" help="For example, '-XL 1:100' with a padding value of 20 would turn into '-XL 1:80-120'."/>
            <param type="select" argument="--interval-merging-rule" label="Rule for merging abutting intervals">
                <option value="ALL" selected="True">ALL</option>
                <option value="OVERLAPPING_ONLY">OVERLAPPING_ONLY</option>
            </param>
            <param type="select" argument="--interval-set-rule" label="Use union or intersection of all included (-L) or excluded (-XL) intervals">
                <option value="UNION" selected="True">UNION</option>
                <option value="INTERSECTION">INTERSECTION</option>
            </param>
        </section>
        <section name="Penalties &amp; Buffers">
            <param type="float" argument="--bqsr-baq-gap-open-penalty" label="BQSR BAQ gap open penalty" value="40.0" />
            <param type="integer" argument="--cloud-prefetch-buffer" label="Size of the cloud-only prefetch buffer (in MB)" value="40" help="0 to disable." />
            <param type="integer" argument="--cloud-index-prefetch-buffer" label="Size of the cloud-only prefetch buffer (in MB)" optional="True" help="Defaults to cloudPrefetchBuffer" />
        </section>
        <section name="Read Qualities">
            <param type="boolean" argument="--use-original-qualitites" label="Use original base qualities (no BQSR/recalibration)" checked="False" help="Use the original base qualities (that were in the data before BQSR/recalibration) which are stored in the OQ tag, if present, rather than post-recalibration quality scores." />
            <param type="integer" argument="--quantizing-levels" label="Number of distinct quality scores in quantized output" value="16" help="Tells BQSR the number of levels of quantization to use to build the quantization table." />
            <param type="integer" argument="--default-base-qualities" label="Default base quality for missing base quality scores" value="-1" help="-1 disables default base quality assignment." />
            <param type="integer" argument="--deletions-default-quality" label="Default base quality for mismatches in covariate model" value="45" help="Enter negative value to disable." />
            <param type="integer" argument="--insertions-default-quality" label="Default base quantity for insertions in covariate model" value="45" help="Enter negative value to disable." />
            <param type="integer" argument="--mismatches-default-quality" label="Default quality for base mismatches covariate" value="-1" help="A default base qualities to use as a prior (reported quality) in the mismatch covariate model." />
        </section>
        <section name="Performance">
            <param type="integer" argument="--indels-context-size" label="Size of the k-mer context to use for base insertions &amp; deletions" min="1" max="13" value="3" />
            <param type="integer" argument="--mismatches-context-size" label="Size of k-mer context to be used for base mismatches" value="2" min="1" max="13" help="The context covariate will use a context of this size to calculate its covariate value for base mismatches." />
            <param type="integer" argument="--gcs-max-retries" value="20" label="Number of times to attempt to re-initiate connection to GCS bucket channel" />
            <param type="integer" argument="--maximum-cycle-value" label="Maximum cycle value permitted for Cycle covariate" value="500" help="Generates an error if Cycle covariate encounters a cycle greater than this value.  Argument ignored if Cycle covariate not used" />
            <param type="boolean" argument="--disable-bam-index-caching" label="Cache bam indexes (reduces memory requirements)" checked="True" />
            <param type="boolean" argument="--use-jdk-deflater" label="Use JDK Deflater" checked="False" help="As opposed to IntelDeflater"/>
            <param type="boolean" argument="--use-jdk-inflater" label="Use JDK Inflater" checked="False" help="As opposed to IntelInflater"/>
        </section>
        <section name="Labeling">
            <param type="text" argument="--binary-tag-name" label="Binary tag Name" optional="True" help="The tag name for the binary tag covariate (if using it)." />
        </section>
        <section name="Macro files" help="Arguments cannot refer to other files.">
            <param type="data" argument="--gatk-config-file" label="GATK config file" optional="True" help="A configuration file to use with the GATK." />
            <param type="data" argument="--arguments-file" label="Argument file" optional="True" help="Add file with arguments to add to GATK call." />
            <param type="data" format=".dict" argument="--sequence-dictionary" label="Master sequence dictionary" optional="True" />
            <param type="file" argument="--read-index" label="Index file for BAM input" optional="True" help="If not specified, the .bai file will be automatically generated." />
        </section>

            <!-- 
                -add-output-sam-program-record,
                -add-output-vcf-command-line,
                -create-output-bam-index, 
                -create-output-bam-md5, 
                -preserve-qscores-less-than,
                -create-output-variant-index, 
                -create-output-variant-md5 
                -QUIET
                -seconds-between-progress-updates
                options ommited -->
    </inputs>
    <outputs>
        <data name="output1" format="table" label="recalibration_report.table"/>
    </outputs>
    <help>
        Generates a recalibration table based on various covariates.
        See: https://gatk.broadinstitute.org/hc/en-us/articles/360037438491-BaseRecalibrator
    </help>
</tool>
